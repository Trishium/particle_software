# -*- coding: utf-8 -*-
"""
Created on Tue Jan 23 14:45:47 2024

@author: pdhum
"""

import os
import time
os.environ["BLINKA_FT232H"]="1"
import board
import digitalio
import kkblinka

def volt2cmd(v):
    # converts voltages into binary commands for the DAC
    p = v/2.5
    if p>1 or p<0:
        print("voltage out of range")
        return
    hexcode = hex((0b01<<22)|(int((p*65535))<<6))
    return [int(hexcode[2:4], 16), int(hexcode[4:6], 16), int(hexcode[6:8], 16)]


def main():
    clk = digitalio.DigitalInOut(board.C0)
    mosi = digitalio.DigitalInOut(board.C2)
    miso = digitalio.DigitalInOut(board.C1)
    cs0 = digitalio.DigitalInOut(board.C3)
    cs0.direction = digitalio.Direction.OUTPUT
    spi=kkblinka.SPIBitBanger(clk, mosi, miso)
    
    cs0.value=True
    try:
        while True:   
            cs0.value=False
            spi.write(volt2cmd(2.5))
            cs0.value=True
            time.sleep(1)
    
    except KeyboardInterrupt:
        pass
    
if __name__ == "__main__":
    main()
